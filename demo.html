<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="UTF-8">
        <title>Tern - ACE Autocompletion demo</title>
        <style type="text/css" media="screen">
            body {
                overflow: hidden;
            }
            #editor {
                margin: 0;
                position: absolute;
                top: 0;
                bottom: 200px;
                left: 0;
                right: 0;
            }
            #issues {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 200px;
                border: 1px solid black;
                font-size:10px;
            }
        </style>
    </head>
    
    <body>
        <pre id="editor"></pre>
        <div id="issues" style="overflow:auto;">
            <select id="modeSelect" onchange="ChangeMode();">
                <option>javascript</option>
                <option>html</option>
            </select>
            <ol>
                <li>May need to check if the correct type is passed to tern for 'doc', it should likely be a ace.editsession, right now it might be the entire ace eidtor.. I'm not sure</li>
                <li></li>
            </ol>
            <h3>to do</h3>
            <ol>
                <li>Add doc change tracking- needs to add on change event to ac, update BuildRequest to check for changes, and update getFragmentAround</li>
                <li>update langauge_tools to allow copmletion priority, which puts tern above local, and uncomment this line in language-tools: //var completers = [snippetCompleter, textCompleter, keyWordCompleter];</li>
                <li>Add the ace tooltip styling in the javascript file (currently in the html file)</li>
                <li>filtering via tern- need input read to fire filtering to tern</li>
                <li>remove the filter proeprty in tern getCompletions request (it should already be filtered by ACE completor)- also remove scrap codes (duplicate filtered list)</li>
            </ol>
            <h3>Ace To CodeMirror</h3>
            <ol>
                <li>Doc
                    <ul>
                        <li>CM.getDoc() = contains document text, size, editor reference, history, mode, cursor, etc...</li>
                        <li>Ace.getSession().getDocument() = contains document text... but not size, cursor, etc..</li>
                    </ul>
                </li>
                <li>Cursor
                    <ul>
                        <li>CM.doc.getCusor()= {line,ch}</li>
                        <li>Ace.getCursorPosistion() = {row,column}</li>
                    </ul>
                </li>
                <li>number of rows
                    <ul>
                        <li>CM.doc.lineCount()</li>
                        <li>Ace.session.getLength()</li>
                    </ul>
                </li>
                <li>x
                    <ul>
                        <li>CM</li>
                        <li>Ace</li>
                    </ul>
                </li>
            </ol>
        </div>
        <script src="helpers.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
        <script>
            var modeDocs = {
                'javascript': '//json test object\nvar jsonObject ={\n    //prop one\n    one:"one", \n    //prop two\n    propTwo:"propTwo"\n};\n\n//type a dot after json object and tern will get peropties\njsonObject\n\n/**\n * Description of this fn\n * @param {int} a - first number\n * @param {decimal} b - second number\n * @param {number} [c] - third number to include \n * @param {bool} [useSum=false] - pass true to use sum instead of product\n * @returns {number} the product of the passed parameters \n */\nfunction TestFn(a, b, c, useSum){\n   if (useSum === true) {\n        if (c) return a + b + c;\n        return a + b;\n    }\n    if (c) return a * b * c;\n    return a * b;\n}\n\n//place cursor inside of parenthesis to see argument hints\nvar tmp = TestFn(100,200);\n\n/** \n * test function with object as argument and jsDoc comments that describe the object properties \n * @param {object} obj \n * @param {bool} [obj.boolProp=false] - bool property \n * @param {array} [obj.arrayProp] - array property \n * @param {string} [obj.stringProp=default string] - string property with default \n * @returns {object} passed object with default values set where properties are missing \n */ \nfunction TestObjectArg(obj){ \n\tif (typeof(obj) !== "object") { \n\t\tthrow new Error("obj parameter is required and must be an object"); \n\t} \n\tif (!obj.boolProp) { \n\t\tobj.boolProp = false; \n\t} \n\tif (!Array.isArray(obj.arrayProp)) { \n\t\tobj.arrayProp = []; \n\t} \n\tif (typeof(obj.stringProp) !== "string") { \n\t\tobj.stringProp = "default string"; \n\t} \n\treturn obj; \n}\n\n//place cursor inside of parenthesis to see advanced object arg hints from comments\nTestObjectArg();\n\n\n',
                'html': '<h1>HTML Mode</h1>\n\n<SCRP>\nalert("html mode");\n</SCRP>'
            }

            //testing mode changing
                function ChangeMode() {
                    var mode = $('#modeSelect').val();
                    editor.session.setMode("ace/mode/" + mode);
                    var doc = modeDocs[mode].replace(/SCRP/g, 'script');
                    editor.setValue(doc);
                }
        </script>
        <!-- load ace -->
        <script src="ace-builds/src-noconflict/ace.js"></script>
        <!-- load ace language tools this allows the following to work: var langTools=a ce.require("ace/ext/language_tools"); <script src="ace-builds/src-noconflict/ext-language_tools.js"></script>



        -->
        <script>
            console.info('left off-- use worker works but currently off because its super slow. Need to get editor change to refilter list on tern  (need the tern doc change tracking) \n\n Arg hints is kind of working. Need to revise the function that determines if we are in the correct place to show arg hints and figure out which argument is currently being typed (based on commas)');
            // throw new Error('Left off: need to make it find parent for update arg hitns and need to make sure it doesnt work when in function definition. Combine the tokens with the string parsing to get this!');
            console.info('need to do pull request for ext-language_tools.js: //need this line of code to add icon in popup from tern if (data.iconClass) {tokens.push({ type: data.iconClass, value:" " });}');

            console.info('left off: need to finish tern aceCommand binding, and add unbindAceKeys when tern is turned off');
            
            console.info('fix session.getLength in track change');
            console.info('would be nice if arg hints worked inside of object but not likely to work..');

            var editor = ace.edit("editor");
            editor.setValue(modeDocs.javascript);
            editor.setTheme("ace/theme/chrome");
            editor.session.setMode("ace/mode/javascript");
            editor.getSession().setUseWrapMode(true);
            editor.getSession().setWrapLimitRange(null, null);
            editor.setShowPrintMargin(false);

            var server = null;
            ace.config.loadModule('ace/ext/language_tools', function() {
                ace.config.loadModule('ace/ext/tern', function() {
                    editor.setOptions({
                        enableTern: true,
                       // ternLocalStringMinLength:3,
                        enableSnippets: false,
                        enableBasicAutocompletion: true
                    });
                    server = ace.require('ace/ext/tern').server;
                });
            });

            //stuff that is not relevant to tern

            //#region custombeautifyextension
            ace.config.loadModule('ace/ext/beautify', function() {
                editor.setOptions({
                    enableBeautify: true
                });
                var beautify = ace.require('ace/ext/beautify');
                window.beautify = beautify;
                editor.commands.addCommands(beautify.commands)
            });
            /**
             * Gets editors mode at cursor posistion (including nested mode) (copied from snipped manager)
             * @param {bool} [allowNestedMode=false] - pass true return nested mode if in mixed html mode
             */
            function getCurrentMode(editor, allowNestedMode) {
                var scope = editor.session.$mode.$id || "";
                scope = scope.split("/").pop();
                if (scope === "html" || scope === "php") {
                    if (scope === "php") scope = "html";
                    var c = editor.getCursorPosition();
                    var state = editor.session.getState(c.row);
                    if (typeof state === "object") {
                        state = state[0];
                    }
                    if (allowNestedMode) {
                        if (state.substring) {
                            if (state.substring(0, 3) == "js-") scope = "javascript";
                            else if (state.substring(0, 4) == "css-") scope = "css";
                            else if (state.substring(0, 4) == "php-") scope = "php";
                        }
                    }
                }
                return scope;
            }
            editor.commands.on('afterExec', function(e) {
               // DBG(arguments,true);
                if (e.command.name === "insertstring" && e.args === "}") {
                    var m = getCurrentMode(editor, true);
                    if (m !== 'javascript' && m !== 'css') {
                        return;
                    }
                    var pos = editor.getSelectionRange().end;
                    var tok = editor.session.getTokenAt(pos.row, pos.column);
                    if (tok) {
                        if (tok.type !== 'string' && tok.type.toString().indexOf('comment') === -1) {
                            editor.jumpToMatching(true);//jumpto and select
                            editor.execCommand('beautify');
                        }
                    }
                }
                //testing auto beautify
                function getMatching(select) {
                    var cursor = editor.getCursorPosition();
                    var range = editor.session.getBracketRange(cursor);
                    if (!range) {
                        range = editor.find({
                            needle: /[{}()\[\]]/g,
                            preventScroll: true,
                            start: {
                                row: cursor.row,
                                column: cursor.column - 1
                            }
                        });
                        if (!range) return;
                        var pos = range.start;
                        if (pos.row == cursor.row && Math.abs(pos.column - cursor.column) < 2) range = editor.session.getBracketRange(pos);
                    }
                    pos = range && range.cursor || pos;
                    if (pos) {
                        if (select) {
                            if (range && range.isEqual(editor.getSelectionRange())) {
                                editor.clearSelection();
                            }
                            else editor.selection.selectTo(pos.row, pos.column);
                        }
                        else {
                            editor.selection.moveTo(pos.row, pos.column);
                        }
                    }
                }
            });

            //#endregion



            //config
            var config = ace.require("ace/config");
            config.init();

            //add commands from kitchen sink demo
            editor.commands.addCommands([{
                name: "execute",
                bindKey: "ctrl+enter",
                exec: function(editor) {
                    try {
                        var r = window.eval(editor.getCopyText() || editor.getValue());
                    }
                    catch (e) {
                        r = e;
                    }
                    editor.cmdLine.setValue(r + "");
                },
                readOnly: true
            }, {
                name: "showKeyboardShortcuts",
                bindKey: {
                    win: "Ctrl-Alt-h",
                    mac: "Command-Alt-h"
                },
                exec: function(editor) {
                    config.loadModule("ace/ext/keybinding_menu", function(module) {
                        module.init(editor);
                        editor.showKeyboardShortcuts();
                    });
                }
            }]);

            //see - https://github.com/ajaxorg/ace/wiki/Embedding-API
            editor.getSession().selection.on('changeCursor', function() {
                //  server.updateArgHints(editor);

                try { //throws error if null
                    var position = editor.getSelectionRange().start;
                    var token = editor.session.getTokenAt(position.row, position.column);
                    if (!token) {
                        $('#CurrentToken').html('');
                        return;
                    }
                    var r = '';
                    r += token.type.toString();
                    if (token.start) {
                        r += "<span style='padding-left:5px; color:red;'>start: " + token.start + "</span>";
                    }
                    if (token.index) {
                        r += "<span style='padding-left:5px; color:red;'>index: " + token.index + "</span>";
                    }
                    r += "<span style='padding-left:5px; color:black; font-size:10px;'>Row " + position.row + "</span>";
                    r += "<span style='padding-left:5px; color:black; font-size:10px;'>Col " + position.column + "</span>";
                    $('#CurrentToken').html(r);
                }
                catch (ex) {
                    console.log(ex);
                }
            });
        </script>
        <div id="CurrentToken" style="color:blue; position:fixed; z-index:99; top:5px; right:5px; font-size:11px;"></div>
    </body>

</html>
